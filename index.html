<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>mobile scanner ¬∑ live sheets</title>
  <style>
    * {
      box-sizing: border-box;
      user-select: none;
    }

    body {
      margin: 0;
      background: lightblue;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app-scroll {
      flex: 1 1 auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 4px;
    }

    .header {
      height: 48px;
      background: #e6e6e9;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      border-bottom: 1px solid #c9c9cc;
      flex-shrink: 0;
    }

    .left-text {
      font-family: "Courier New", monospace;
      font-weight: 700;
      font-size: 20px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .gps-icon {
      display: flex;
      align-items: center;
      gap: 4px;
      background: #d2d2d8;
      padding: 4px 12px;
      border-radius: 30px;
      font-family: "Courier New", monospace;
      font-size: 14px;
      border: 1px solid #aaaab0;
    }
    
    #timeDisplay {
      font-family: "Courier New", monospace;
      font-size: 18px;
      background: #d2d2d8;
      padding: 4px 12px;
      border-radius: 30px;
      border: 1px solid #aaaab0;
    }

    .container {
      padding: 18px;
    }

    .label-title {
      font-family: "Courier New", monospace;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .scan-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .scan-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: lightgreen;
      border: 1px solid #b8b8bb;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-family: "Courier New", monospace;
      font-weight: 700;
      font-size: 14px;
    }

    .barcode-input {
      flex: 1;
      padding: 10px;
      font-size: 18px;
      font-family: "Courier New", monospace;
      border: 1px solid #b8b8bb;
      border-radius: 6px;
      background: lightgray;
    }

    .label-box {
      margin: 24px 0 12px;
      border: 2px solid #b8b8bb;
      background: #ffffff;
      border-radius: 8px;
      padding: 12px 10px;
    }
    
    .label-box-header {
      display: flex;
      justify-content: space-between;
      font-family: "Courier New", monospace;
      font-weight: 700;
      font-size: 18px;
      border-bottom: 1px solid #c9c9cc;
      padding-bottom: 6px;
    }
    
    .label-counter {
      background: #e6e6e9;
      padding: 0 12px;
      border-radius: 20px;
    }
    
    .scanned-items {
      min-height: 80px;
      max-height: 160px;
      overflow-y: auto;
      background: #f8f8fa;
      border-radius: 4px;
      margin: 10px 0 8px;
      padding: 4px;
      font-family: "Courier New", monospace;
      border: 1px solid #d2d2d5;
    }
    
    .scanned-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px dashed #c0c0c5;
    }
    
    .item-index {
      color: #3a3a44;
      min-width: 32px;
    }
    
    .item-barcode {
      font-weight: 600;
    }
    
    .empty-label {
      color: #8e8e98;
      text-align: center;
      padding: 12px;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 12px;
    }
    
    .action-btn {
      background: #dcdce0;
      border: 1px solid #b8b8bb;
      border-radius: 6px;
      padding: 8px 24px;
      font-family: "Courier New", monospace;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
    }
    
    .esc-btn { background: #f0d0d0; }
    .enter-btn { background: #d0f0d0; }

    .status-block {
      margin-top: 20px;
      display: none;
    }

    .status-label {
      font-family: "Courier New", monospace;
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .status-select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      font-family: "Courier New", monospace;
      border: 1px solid #b8b8bb;
      border-radius: 6px;
      background: #ffffff;
    }

    .signature-overlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center;
      z-index: 2000;
    }
    
    .signature-container {
      width:90%; max-width:400px; background:#fff; border-radius:16px; padding:20px;
      border: 2px solid #b8b8bb;
    }
    
    .signature-title { font-size:20px; font-weight:700; margin-bottom:6px; }
    .signature-subtitle { color:#1e4d2b; font-weight:600; margin-bottom:12px; }
    .signature-barcode { background:#eaeef2; padding:8px; border-radius:6px; font-family: monospace; }
    .signature-canvas-container { background:#f0f4f8; border:2px solid #b8b8bb; border-radius:8px; height:150px; }
    #signatureCanvas { width:100%; height:150px; background:#fff; cursor:crosshair; }
    .signature-actions { display:flex; gap:8px; margin-top:16px; }
    .signature-btn { flex:1; padding:10px; border:1px solid #b8b8bb; background:#dcdce0; border-radius:6px; font-weight:700; }

    .overlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:1500;
    }
    
    .barcode-frame {
      width:300px; background:#000; border:4px solid #9bbc7b; border-radius:10px; overflow:hidden;
      position: relative;
    }
    
    .close-btn {
      position: absolute; top:-40px; right:0; background:#fff; border:1px solid #b8b8bb; 
      padding:6px 12px; border-radius:6px; cursor:pointer;
    }
    
    video { width:100%; height:auto; }

    .location-preview {
      font-family: monospace;
      font-size: 12px;
      margin-top: 8px;
      padding: 4px;
      background: #e6e6e9;
      border-radius: 4px;
    }

    /* ========== TOGGLEABLE KEYPAD (ANDROID STYLE) ========== */
    .keypad-fixed {
      flex-shrink: 0;
      background: #d2d2d8;
      border-top: 2px solid #aaaab0;
      padding: 6px 4px 4px 4px;
      width: 100%;
      font-family: 'Courier New', monospace;
      transition: 0.1s;
    }

    .keypad-row {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-bottom: 5px;
    }

    .key-btn {
      background: #f0f0f6;
      border: 1px solid #7a7a88;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-weight: 700;
      font-size: 22px;
      padding: 8px 0;
      text-align: center;
      flex: 1 1 0px;
      min-width: 36px;
      max-width: 48px;
      box-shadow: 0 2px 0 #6a6a78;
      cursor: pointer;
      color: #111;
      line-height: 1;
    }
    .key-btn:active {
      transform: translateY(2px);
      box-shadow: none;
      background: #d8d8e2;
    }

    /* wider keys for specials */
    .key-btn.wide-esc {
      flex: 1.2 1.2 0px;
      max-width: 70px;
      font-size: 18px;
      background: #f0d0d0;
    }
    .key-btn.wide-123, .key-btn.mode-btn {
      flex: 1.2 1.2 0px;
      max-width: 70px;
      font-size: 18px;
      background: #d0d0f0;
    }
    .key-btn.mode-sym {
      background: #c0c0e0;
    }
    .key-btn.enter-key {
      background: #d0f0d0;
      max-width: 70px;
      font-size: 18px;
    }
    .key-btn.space {
      flex: 3 3 0px;
      max-width: 160px;
      background: #e6e6f0;
    }
    .key-btn.sym-dark {
      background: #c0c0d0;
    }

    /* mode selector row (123 | SYM | space ... ) */
    .mode-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 6px;
      padding: 0 2px;
    }
    .mode-btn {
      background: #b8b8d0;
      border: 1px solid #7a7a88;
      border-radius: 6px;
      padding: 8px 12px;
      font-weight: bold;
      font-size: 18px;
      font-family: 'Courier New', monospace;
      cursor: pointer;
      box-shadow: 0 2px 0 #5a5a68;
      text-align: center;
      flex: 1;
    }
    .mode-btn.active {
      background: #9a9ac0;
      transform: translateY(2px);
      box-shadow: none;
    }
    .mode-btn:active {
      transform: translateY(2px);
      box-shadow: none;
    }

    /* hide keypad sections */
    .keypad-section {
      display: none;
    }
    .keypad-section.active {
      display: block;
    }

    /* numeric specific */
    .num-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 6px;
    }
    .num-row .key-btn {
      max-width: 60px;
      font-size: 24px;
    }
    .num-special {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 2px;
    }
    .num-special .key-btn {
      max-width: 70px;
      font-size: 20px;
    }

    /* symbol specific */
    .sym-main .keypad-row {
      gap: 4px;
    }
    .sym-main .key-btn {
      font-size: 20px;
      max-width: 44px;
    }
  </style>
</head>
<body>

<div class="header">
  <div class="left-text">SCAN BARCODE</div>
  <div class="header-right">
    <div class="gps-icon" id="gpsIndicator">
      <span>üìç</span><span id="gpsStatus">acquiring</span>
    </div>
    <div id="timeDisplay">--:--:--</div>
  </div>
</div>

<!-- scrollable main content -->
<div class="app-scroll">
  <div class="container">
    <div class="label-title">SCAN barcode ID</div>
    <div class="scan-row">
      <button class="scan-btn" onclick="openScanner()">üì∑ SCAN</button>
      <input type="text" id="barcodeField" class="barcode-input" placeholder="scan or enter" autocomplete="off" inputmode="none">
    </div>

    <div class="label-box">
      <div class="label-box-header">
        <span># LABEL ID</span>
        <span class="label-counter" id="itemCounter">0</span>
      </div>
      <div class="scanned-items" id="scannedListContainer">
        <div class="empty-label">‚Äî no scans ‚Äî</div>
      </div>
      <div class="action-buttons">
        <button class="action-btn esc-btn" id="escBtn">ESC</button>
        <button class="action-btn enter-btn" id="enterBtn">ENTER</button>
      </div>
    </div>

    <div class="status-block" id="batchStatusBlock">
      <div class="status-label">CHOOSE STATUS FOR ALL SCANNED PACKAGES</div>
      <select class="status-select" id="batchStatusSelect">
        <option value="">Select status...</option>
        <option>Label Created</option>
        <option>UEXS Awaitng Item</option>
        <option>UEXS picked up</option>
        <option>UEXS Departed Post Office</option>
        <option>UEXS Arrived at Origin Hub</option>
        <option>UEXS Departed Origin Hub</option>
        <option>UEXS In Transit</option>
        <option>UEXS Arrived Reginoal Hub</option>
        <option>UEXS Processed thru Hub</option>
        <option>UEXS Departed Hub</option>
        <option>UEXS Arrived Local Hub</option>
        <option>UEXS Sorted</option>
        <option>UEXS Loaded On Delivery Vehicle</option>
        <option>UEXS Out For Delivery</option>
        <option>UEXS DELIVERED</option>
      </select>
      <div id="locationPreview" class="location-preview"></div>
    </div>
  </div>
</div>

<!-- ========== SINGLE TOGGLEABLE KEYPAD (ANDROID STYLE) ========== -->
<div class="keypad-fixed">
  <!-- mode switcher row: 123 | SYM | space (but space is actual key) we need ABC mode too, so better: ABC 123 SYM as mode toggles -->
  <div class="mode-row">
    <div class="mode-btn" id="modeABC" data-mode="abc">ABC</div>
    <div class="mode-btn" id="mode123" data-mode="num">123</div>
    <div class="mode-btn" id="modeSYM" data-mode="sym">SYM</div>
  </div>

  <!-- QWERTY section (default active) -->
  <div id="qwerty-section" class="keypad-section active">
    <div class="keypad-row">
      <button class="key-btn" data-key="Q">Q</button><button class="key-btn" data-key="W">W</button><button class="key-btn" data-key="E">E</button><button class="key-btn" data-key="R">R</button><button class="key-btn" data-key="T">T</button><button class="key-btn" data-key="Y">Y</button><button class="key-btn" data-key="U">U</button><button class="key-btn" data-key="I">I</button><button class="key-btn" data-key="O">O</button><button class="key-btn" data-key="P">P</button>
    </div>
    <div class="keypad-row">
      <button class="key-btn" data-key="A">A</button><button class="key-btn" data-key="S">S</button><button class="key-btn" data-key="D">D</button><button class="key-btn" data-key="F">F</button><button class="key-btn" data-key="G">G</button><button class="key-btn" data-key="H">H</button><button class="key-btn" data-key="J">J</button><button class="key-btn" data-key="K">K</button><button class="key-btn" data-key="L">L</button>
    </div>
    <div class="keypad-row">
      <button class="key-btn wide-esc" data-key="esc">ESC</button>
      <button class="key-btn" data-key="Z">Z</button><button class="key-btn" data-key="X">X</button><button class="key-btn" data-key="C">C</button><button class="key-btn" data-key="V">V</button><button class="key-btn" data-key="B">B</button><button class="key-btn" data-key="N">N</button><button class="key-btn" data-key="M">M</button>
    </div>
    <!-- space and enter row -->
    <div class="keypad-row">
      <button class="key-btn space" data-key="space">‚ê£ space</button>
      <button class="key-btn enter-key" data-key="enter">ENT</button>
    </div>
  </div>

  <!-- NUMERIC section -->
  <div id="num-section" class="keypad-section">
    <div class="num-row">
      <button class="key-btn" data-key="1">1</button><button class="key-btn" data-key="2">2</button><button class="key-btn" data-key="3">3</button>
    </div>
    <div class="num-row">
      <button class="key-btn" data-key="4">4</button><button class="key-btn" data-key="5">5</button><button class="key-btn" data-key="6">6</button>
    </div>
    <div class="num-row">
      <button class="key-btn" data-key="7">7</button><button class="key-btn" data-key="8">8</button><button class="key-btn" data-key="9">9</button>
    </div>
    <div class="num-special">
      <button class="key-btn sym-dark" data-key="abc" style="background:#c0c0d0;">ABC</button>
      <button class="key-btn sym-dark" data-key="sym" style="background:#c0c0d0;">SYM</button>
      <button class="key-btn" data-key="-">-</button>
      <button class="key-btn" data-key="0">0</button>
      <button class="key-btn" data-key=".">.</button>
      <button class="key-btn enter-key" data-key="enter">ENT</button>
    </div>
  </div>

  <!-- SYMBOL section -->
  <div id="sym-section" class="keypad-section sym-main">
    <div class="keypad-row">
      <button class="key-btn" data-key="!">!</button><button class="key-btn" data-key="@">@</button><button class="key-btn" data-key="#">#</button><button class="key-btn" data-key="$">$</button><button class="key-btn" data-key="%">%</button><button class="key-btn" data-key="^">^</button><button class="key-btn" data-key="&">&</button><button class="key-btn" data-key="*">*</button><button class="key-btn" data-key="(">(</button><button class="key-btn" data-key=")">)</button>
    </div>
    <div class="keypad-row">
      <button class="key-btn" data-key="-">-</button><button class="key-btn" data-key="_">_</button><button class="key-btn" data-key="+">+</button><button class="key-btn" data-key="=">=</button><button class="key-btn" data-key="{">{</button><button class="key-btn" data-key="}">}</button><button class="key-btn" data-key="[">[</button><button class="key-btn" data-key="]">]</button><button class="key-btn" data-key="\\">\</button><button class="key-btn" data-key="|">|</button>
    </div>
    <div class="keypad-row">
      <button class="key-btn" data-key=";">;</button><button class="key-btn" data-key=":">:</button><button class="key-btn" data-key="'">'</button><button class="key-btn" data-key='"'>"</button><button class="key-btn" data-key=",">,</button><button class="key-btn" data-key="<"><</button><button class="key-btn" data-key=".">.</button><button class="key-btn" data-key=">">></button><button class="key-btn" data-key="/">/</button><button class="key-btn" data-key="?">?</button>
    </div>
    <div class="keypad-row">
      <button class="key-btn space" data-key="space">‚ê£ space</button>
      <button class="key-btn enter-key" data-key="enter">ENT</button>
    </div>
    <div style="height:2px"></div>
  </div>
</div>

<!-- overlays -->
<div id="signaturePopup" class="signature-overlay">
  <div class="signature-container">
    <div class="signature-title">SIGNATURE REQUIRED</div>
    <div class="signature-subtitle">Delivered ‚Äì Customer Sign</div>
    <div id="signatureBarcodeDisplay" class="signature-barcode"></div>
    <div class="signature-canvas-container">
      <canvas id="signatureCanvas" width="500" height="150"></canvas>
    </div>
    <div class="signature-actions">
      <button id="clearSignatureBtn" class="signature-btn">CLEAR</button>
      <button id="cancelSignatureBtn" class="signature-btn">CANCEL</button>
      <button id="submitSignatureBtn" class="signature-btn">SUBMIT</button>
    </div>
  </div>
</div>

<div class="overlay" id="scannerOverlay">
  <div class="barcode-frame">
    <button class="close-btn" onclick="closeScanner()">‚úï</button>
    <video id="video" autoplay playsinline></video>
  </div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
(function() {
  // ============================================
  // CONFIGURATION - REPLACE WITH YOUR SHEETDB URL
  // ============================================
  const SHEETDB_URL = 'https://sheetdb.io/api/v1/zw5qp6e3pdvsf'; // Replace with your actual URL
  
  // BEEP sound
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playScanSound() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = 920;
    gain.gain.value = 0.5;
    osc.connect(gain).connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.15);
  }

  // TIME
  function updateTime() {
    const now = new Date();
    let h = now.getHours().toString().padStart(2,'0');
    let m = now.getMinutes().toString().padStart(2,'0');
    let s = now.getSeconds().toString().padStart(2,'0');
    document.getElementById('timeDisplay').innerText = `${h}:${m}:${s}`;
  }
  updateTime(); setInterval(updateTime, 1000);

  // GPS + REVERSE GEOCODING
  const gpsStatus = document.getElementById('gpsStatus');
  let currentLat = '', currentLon = '';
  let currentCity = '', currentState = '', currentZip = '';
  
  async function getLocationDetails(lat, lon) {
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`
      );
      const data = await response.json();
      return {
        city: data.address.city || data.address.town || data.address.village || data.address.suburb || '',
        state: data.address.state || '',
        zip: data.address.postcode || ''
      };
    } catch (error) {
      return { city: '', state: '', zip: '' };
    }
  }

  function updateGPS() {
    if (!navigator.geolocation) { 
      gpsStatus.innerText = 'no gps'; 
      return; 
    }
    navigator.geolocation.getCurrentPosition(
      async pos => {
        currentLat = pos.coords.latitude.toFixed(5);
        currentLon = pos.coords.longitude.toFixed(5);
        
        const location = await getLocationDetails(currentLat, currentLon);
        currentCity = location.city;
        currentState = location.state;
        currentZip = location.zip;
        
        gpsStatus.innerText = `${currentLat}, ${currentLon}`;
        document.getElementById('locationPreview').innerHTML = 
          `üìç ${currentCity || '??'}, ${currentState || '??'} ${currentZip || '??'}`;
      },
      err => { 
        gpsStatus.innerText = 'unavl';
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  }
  updateGPS(); setInterval(updateGPS, 30000);

  // GLOBAL DATA
  let scannedBarcodes = [];
  const barcodeField = document.getElementById('barcodeField');
  const scannedContainer = document.getElementById('scannedListContainer');
  const itemCounter = document.getElementById('itemCounter');
  const batchStatusBlock = document.getElementById('batchStatusBlock');
  const batchStatusSelect = document.getElementById('batchStatusSelect');
  const escBtn = document.getElementById('escBtn');
  const enterBtn = document.getElementById('enterBtn');

  // Signature
  const signaturePopup = document.getElementById('signaturePopup');
  const signatureCanvas = document.getElementById('signatureCanvas');
  const signatureBarcodeDisplay = document.getElementById('signatureBarcodeDisplay');
  let currentBarcodeForSignature = '';
  let currentSignatureText = '';

  // ZXING
  let codeReader = new ZXing.BrowserMultiFormatReader();
  let currentStream = null;

  // RENDER SCANNED LIST
  function renderScannedList() {
    const container = scannedContainer;
    container.innerHTML = '';
    if (scannedBarcodes.length === 0) {
      container.innerHTML = '<div class="empty-label">‚Äî no scans ‚Äî</div>';
      itemCounter.innerText = '0';
      return;
    }
    scannedBarcodes.forEach((bc, idx) => {
      const div = document.createElement('div');
      div.className = 'scanned-item';
      div.innerHTML = `<span class="item-index">#${idx+1}</span><span class="item-barcode">${bc}</span>`;
      container.appendChild(div);
    });
    itemCounter.innerText = scannedBarcodes.length;
  }

  // ADD BARCODE
  function addBarcodeToList(barcode) {
    if (!barcode || barcode.trim() === '') return;
    barcode = barcode.trim();
    scannedBarcodes.push(barcode);
    playScanSound();
    renderScannedList();
    barcodeField.value = '';
    barcodeField.focus();
    batchStatusBlock.style.display = 'none';
    batchStatusSelect.value = '';
  }

  // manual entry from keypad
  function simulateKeyPress(key) {
    const input = barcodeField;
    if (key === 'space') {
      input.value += ' ';
    } else if (key === 'backspace') {
      input.value = input.value.slice(0, -1);
    } else if (key === 'enter') {
      const val = input.value.trim();
      if (val !== '') addBarcodeToList(val);
    } else if (key === 'esc') {
      // optional clear field?
      input.value = '';
    } else if (key === 'abc' || key === 'sym' || key === '123') {
      // these are mode toggles, handled separately
      return;
    } else {
      input.value += key;
    }
    input.focus();
  }

  // Keypad listener
  document.querySelector('.keypad-fixed').addEventListener('click', (e) => {
    const btn = e.target.closest('.key-btn');
    if (!btn) return;
    const key = btn.dataset.key;
    if (key) simulateKeyPress(key);
  });

  // Mode switching
  const modeABC = document.getElementById('modeABC');
  const mode123 = document.getElementById('mode123');
  const modeSYM = document.getElementById('modeSYM');
  const qwertySec = document.getElementById('qwerty-section');
  const numSec = document.getElementById('num-section');
  const symSec = document.getElementById('sym-section');

  function setActiveMode(mode) {
    [modeABC, mode123, modeSYM].forEach(btn => btn.classList.remove('active'));
    [qwertySec, numSec, symSec].forEach(sec => sec.classList.remove('active'));
    
    if (mode === 'abc') {
      modeABC.classList.add('active');
      qwertySec.classList.add('active');
    } else if (mode === 'num') {
      mode123.classList.add('active');
      numSec.classList.add('active');
    } else if (mode === 'sym') {
      modeSYM.classList.add('active');
      symSec.classList.add('active');
    }
  }

  modeABC.addEventListener('click', () => setActiveMode('abc'));
  mode123.addEventListener('click', () => setActiveMode('num'));
  modeSYM.addEventListener('click', () => setActiveMode('sym'));

  // also handle any "ABC" or "SYM" keys inside numeric keypad (they toggle mode)
  document.addEventListener('click', (e) => {
    const target = e.target;
    if (target.classList.contains('key-btn') && target.dataset.key === 'abc') {
      setActiveMode('abc');
    } else if (target.classList.contains('key-btn') && target.dataset.key === 'sym') {
      setActiveMode('sym');
    } else if (target.classList.contains('key-btn') && target.dataset.key === '123') {
      setActiveMode('num');
    }
  });

  // hardware keyboard support
  barcodeField.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      const val = barcodeField.value.trim();
      if (val !== '') addBarcodeToList(val);
    }
  });

  // SCANNER
  window.openScanner = async function() {
    document.getElementById('scannerOverlay').style.display = 'flex';
    try {
      const video = document.getElementById('video');
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      currentStream = stream;
      video.srcObject = stream;
      codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
        if (result) {
          addBarcodeToList(result.text);
          closeScanner();
        }
      });
    } catch (err) {
      alert('Camera access denied');
      closeScanner();
    }
  };

  window.closeScanner = function() {
    document.getElementById('scannerOverlay').style.display = 'none';
    if (currentStream) {
      currentStream.getTracks().forEach(t => t.stop());
      currentStream = null;
    }
    codeReader.reset();
  };

  // ESC
  escBtn.addEventListener('click', function() {
    if (scannedBarcodes.length > 0 && confirm('Clear all scanned barcodes?')) {
      scannedBarcodes = [];
      renderScannedList();
      batchStatusBlock.style.display = 'none';
      batchStatusSelect.value = '';
    }
  });

  // ENTER (show status dropdown)
  enterBtn.addEventListener('click', function() {
    if (scannedBarcodes.length === 0) {
      alert('No barcodes.');
      return;
    }
    batchStatusBlock.style.display = 'block';
  });

  // SIGNATURE CANVAS
  function setupCanvas() {
    const ctx = signatureCanvas.getContext('2d');
    ctx.clearRect(0,0,500,150);
    ctx.strokeStyle = '#aaa'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(30,110); ctx.lineTo(470,110); ctx.stroke();
    ctx.strokeStyle = '#00117c'; ctx.lineWidth = 2.5; ctx.lineCap = 'round';
  }
  
  let isDrawing = false, lastX, lastY;
  
  function startDraw(e) {
    isDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    const scaleX = 500/rect.width, scaleY = 150/rect.height;
    const x = (e.clientX - rect.left)*scaleX, y = (e.clientY - rect.top)*scaleY;
    lastX = x; lastY = y;
  }
  
  function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    const rect = signatureCanvas.getBoundingClientRect();
    const scaleX = 500/rect.width, scaleY = 150/rect.height;
    const x = (e.clientX - rect.left)*scaleX, y = (e.clientY - rect.top)*scaleY;
    const ctx = signatureCanvas.getContext('2d');
    ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke();
    lastX = x; lastY = y;
  }
  
  signatureCanvas.addEventListener('mousedown', startDraw);
  signatureCanvas.addEventListener('mousemove', draw);
  signatureCanvas.addEventListener('mouseup', ()=>{isDrawing=false});
  signatureCanvas.addEventListener('mouseout', ()=>{isDrawing=false});
  signatureCanvas.addEventListener('touchstart', (e)=>{e.preventDefault(); const t=e.touches[0]; startDraw(t);});
  signatureCanvas.addEventListener('touchmove', (e)=>{e.preventDefault(); const t=e.touches[0]; draw(t);});
  signatureCanvas.addEventListener('touchend', ()=>{isDrawing=false});

  document.getElementById('clearSignatureBtn').addEventListener('click', ()=>{
    const ctx = signatureCanvas.getContext('2d');
    ctx.clearRect(0,0,500,150);
    setupCanvas();
  });
  
  document.getElementById('cancelSignatureBtn').addEventListener('click', ()=>{
    signaturePopup.style.display = 'none';
    batchStatusSelect.value = '';
  });
  
  document.getElementById('submitSignatureBtn').addEventListener('click', ()=>{
    const ctx = signatureCanvas.getContext('2d');
    const pixels = ctx.getImageData(0,0,500,150).data;
    let empty = true;
    for (let i=0; i<pixels.length; i+=4) if (pixels[i] < 250) { empty=false; break; }
    if (empty) { alert('Please draw signature.'); return; }
    
    const name = prompt("Enter recipient name:", "");
    if (!name) return;
    
    currentSignatureText = name;
    signaturePopup.style.display = 'none';
    
    const selectedStatus = batchStatusSelect.options[batchStatusSelect.selectedIndex]?.text;
    if (selectedStatus) sendBatchToSheets(selectedStatus);
  });

  // STATUS CHANGE
  batchStatusSelect.addEventListener('change', function() {
    const selectedStatus = batchStatusSelect.options[batchStatusSelect.selectedIndex]?.text;
    if (!selectedStatus || scannedBarcodes.length === 0) return;

    const hasE = scannedBarcodes.some(bc => bc.toUpperCase().startsWith('E'));
    if (selectedStatus === 'UEXS DELIVERED' && hasE) {
      const firstE = scannedBarcodes.find(bc => bc.toUpperCase().startsWith('E'));
      if (firstE) {
        currentBarcodeForSignature = firstE;
        signatureBarcodeDisplay.innerText = firstE;
        setupCanvas();
        signaturePopup.style.display = 'flex';
        return;
      }
    }
    sendBatchToSheets(selectedStatus);
  });

  // ============================================
  // SEND TO SHEETDB
  // ============================================
  async function sendBatchToSheets(status) {
    if (scannedBarcodes.length === 0) return;
    
    const timestamp = new Date().toISOString().slice(0,19).replace('T',' ');
    const batchId = 'BATCH-' + Date.now().toString(36).toUpperCase();
    
    const records = scannedBarcodes.map(barcode => ({
      tracking_id: barcode,
      status: status,
      timestamp: timestamp,
      latitude: currentLat || '',
      longitude: currentLon || '',
      city: currentCity || '',
      state: currentState || '',
      zip_code: currentZip || '',
      signature_text: (status === 'UEXS DELIVERED' && currentSignatureText) ? currentSignatureText : '',
      batch_id: batchId
    }));

    const originalBtnText = enterBtn.innerText;
    enterBtn.innerText = 'SENDING...';
    enterBtn.disabled = true;

    try {
      const response = await fetch(SHEETDB_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(records)
      });

      const result = await response.json();
      
      if (response.ok) {
        alert(`‚úÖ SUCCESS!\n${records.length} records sent to Google Sheets\nBatch ID: ${batchId}`);
        scannedBarcodes = [];
        renderScannedList();
        batchStatusBlock.style.display = 'none';
        batchStatusSelect.value = '';
        currentSignatureText = '';
        console.log('SheetDB response:', result);
      } else {
        throw new Error('Failed to send');
      }
      
    } catch (error) {
      alert('‚ùå Error sending to database. Check console.');
      console.error('SheetDB error:', error);
      console.log('BACKUP DATA:', JSON.stringify(records, null, 2));
    } finally {
      enterBtn.innerText = originalBtnText;
      enterBtn.disabled = false;
    }
  }

  // INIT
  renderScannedList();
  setupCanvas();
  // default mode ABC active
  setActiveMode('abc');
})();
</script>
</body>
</html>
